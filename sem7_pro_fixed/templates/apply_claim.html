{% extends "base.html" %}
{% block content %}

<div class="row g-4">

  <!-- ================= CLAIM TYPE SELECT ================= -->
  <div class="col-12">
    <div class="btn-group w-100 mb-3">
      <button class="btn btn-outline-primary {% if claim_type == 'vehicle' %}active{% endif %}"
              onclick="location.href='?type=vehicle'">
        ðŸš— Vehicle Claim
      </button>
      <button class="btn btn-outline-secondary {% if claim_type == 'document' %}active{% endif %}"
              onclick="location.href='?type=document'">
        ðŸ“„ Document Claim
      </button>
    </div>
  </div>

  <!-- ===================================================== -->
  <!-- ================= VEHICLE CLAIM ===================== -->
  <!-- ===================================================== -->
  {% if claim_type == "vehicle" %}
  <div class="col-lg-5">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h5 class="card-title">ðŸš— Vehicle Damage Assessment</h5>

        {% if not report or not report.estimated_damage %}
        <form method="post" enctype="multipart/form-data">
          <input type="hidden" name="claim_type" value="vehicle">
          <input type="hidden" name="stage" value="estimate">

          <div class="mb-3">
            <label class="form-label">Upload Damage Images</label>
            <input type="file"
                   name="claim_files"
                   class="form-control"
                   accept="image/*"
                   multiple
                   required>
            <small class="text-muted">
              Upload 1â€“5 clear images from different angles
            </small>
          </div>

          <button class="btn btn-primary w-100"
                  onclick="this.disabled=true; this.form.submit();">
            Analyze Damage
          </button>
        </form>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-7">
    <h5 class="mb-3">Assessment</h5>

    {% if report and report.estimated_damage %}
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h6 class="fw-bold">AI Estimated Damage Cost</h6>
          <h3 class="text-success">â‚¹{{ "{:,}".format(report.estimated_damage) }}</h3>
          <div class="text-muted small">
            Based on {{ report.signals.images_used }} image(s) (averaged)
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="fw-bold">Your Claim Amount</h6>

          <form method="post">
            <input type="hidden" name="claim_type" value="vehicle">
            <input type="hidden" name="stage" value="bargain">
            <input type="hidden" name="ai_estimate" value="{{ report.estimated_damage }}">

            <input type="number"
                   name="claim_amount"
                   class="form-control mb-2"
                   value="{{ report.estimated_damage }}"
                   min="{{ (report.estimated_damage * 0.7)|int }}"
                   max="{{ (report.estimated_damage * 1.5)|int }}"
                   required>

            <button class="btn btn-success w-100"
                    onclick="this.disabled=true; this.form.submit();">
              Submit Vehicle Claim
            </button>
          </form>
        </div>
      </div>

    {% elif report and report.decision %}
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="fw-bold">Final Decision</h5>

          <span class="badge
            {% if report.decision == 'Auto-Approve' %}bg-success
            {% elif report.decision == 'Manual Review' %}bg-warning text-dark
            {% else %}bg-danger{% endif %}">
            {{ report.decision }}
          </span>
        </div>
      </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- ===================================================== -->
  <!-- ================= DOCUMENT CLAIM ==================== -->
  <!-- ===================================================== -->
  {% if claim_type == "document" %}
  <div class="col-lg-6">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h5 class="card-title">ðŸ“„ Document-based Claim</h5>

        <form method="post" enctype="multipart/form-data">
          <input type="hidden" name="claim_type" value="document">

          <div class="mb-3">
            <label class="form-label">Upload Claim Documents</label>
            <input type="file"
                   name="claim_files"
                   class="form-control"
                   multiple
                   required>
            <small class="text-muted">
              Bills, reports, prescriptions, discharge summary
            </small>
          </div>

          <div class="mb-3">
            <label class="form-label">Claim Amount</label>
            <input type="number" name="claim_amount" class="form-control" required>
          </div>

          <button class="btn btn-primary w-100"
                  onclick="this.disabled=true; this.form.submit();">
            Submit Document Claim
          </button>
        </form>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    {% if report %}
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="fw-bold">AI Decision</h6>

        <span class="badge
          {% if report.decision == 'Auto-Approve' %}bg-success
          {% elif report.decision == 'Manual Review' %}bg-warning text-dark
          {% else %}bg-danger{% endif %}">
          {{ report.decision }}
        </span>

        <div class="mt-2 text-muted">
          Risk Score: {{ (report.risk_score * 100)|round(1) }}%
        </div>

        <pre class="small mt-2 bg-light p-2 rounded">
{{ report.signals | tojson(indent=2) }}
        </pre>
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

</div>

{% endblock %}
