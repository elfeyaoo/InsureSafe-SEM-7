{% extends "base.html" %}
{% block content %}
<h4 class="mb-3">âš™ï¸ Admin Panel</h4>

<div class="row g-3">
<!-- ================= STATS (VERTICAL) ================= -->
<div class="col-lg-4 col-md-12">
  <div class="card border-0 shadow-sm rounded-4 h-100">
    <div class="card-body d-flex flex-column justify-content-between px-4">

      <!-- USERS -->
      <div class="text-center py-4 border-bottom">
        <div class="stat-label">ğŸ‘¤ Users</div>
        <div class="stat-number">{{ counts.n_users }}</div>
      </div>

      <!-- POLICIES -->
      <div class="text-center py-4 border-bottom">
        <div class="stat-label">ğŸ“„ Policies</div>
        <div class="stat-number">{{ counts.n_up }}</div>
      </div>

      <!-- CLAIMS -->
      <div class="text-center py-4">
        <div class="stat-label">ğŸ“ Claims</div>
        <div class="stat-number">{{ counts.n_c }}</div>
      </div>

    </div>
  </div>
</div>

  <!-- ================= USERS TABLE ================= -->
  <div class="col-lg-8 col-md-12">
    <div class="card border-0 shadow-sm rounded-3 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="mb-0">ğŸ‘¥ Registered Users</h6>
          <input type="text" id="userSearch"
                 class="form-control form-control-sm w-50"
                 placeholder="ğŸ” Search users...">
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle table-hover" id="usersTable">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Email Status</th>
                <th>Account</th>
                <th class="text-center">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for u in users %}
              <tr>
                <td>{{ u._id|string }}</td>
                <td>{{ u.name }}</td>

                <!-- EMAIL + VERIFIED BADGE -->
                <td>
                  {{ u.email }}
                </td>

                <!-- ROLE -->
                <td>
                  {% if u.is_admin %}
                    <span class="badge bg-danger">Admin</span>
                  {% else %}
                    <span class="badge bg-info">User</span>
                  {% endif %}
                </td>

                <!-- EMAIL VERIFIED -->
                <td>
                  {% if u.email_verified %}
                    <span class="badge bg-success">âœ” Verified</span>
                  {% else %}
                    <span class="badge bg-warning text-dark">â³ Not Verified</span>
                  {% endif %}
                </td>

                <!-- ACCOUNT STATUS -->
                <td>
                  <span class="badge {{ 'bg-success' if u.is_active else 'bg-secondary' }}">
                    {{ 'Active' if u.is_active else 'Inactive' }}
                  </span>
                </td>

                <!-- ACTIONS -->
                <td class="text-center">
                  {% if not u.is_admin %}
                    <div class="d-flex gap-1 justify-content-center">
                      <a href="{{ url_for('admin_toggle', uid=u._id|string) }}"
                         class="btn btn-sm btn-outline-primary">
                        Toggle
                      </a>

                      {% if not u.email_verified %}
                        <a href="{{ url_for('admin_verify_email', uid=u._id|string) }}"
                           class="btn btn-sm btn-outline-success">
                          Verify
                        </a>
                      {% endif %}
                    </div>
                  {% else %}
                    â€”
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>


<!-- ================= CLAIMS TABLE ================= -->
<div class="card border-0 shadow-sm mt-4">
  <div class="card-header bg-dark text-white">ğŸ“ Claims Overview</div>
  <div class="card-body table-responsive">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th>ID</th><th>Policy</th><th>Type</th>
          <th>Amount</th><th>Risk</th><th>Decision</th><th>Date</th>
        </tr>
      </thead>
      <tbody>
        {% for c in claims %}
        <tr>
          <td>#{{ c._id }}</td>
          <td>{{ c.policy.name }}</td>
          <td>
            {% if c.claim_type == "vehicle" %}
              <span class="badge bg-warning">ğŸš— Vehicle</span>
            {% else %}
              <span class="badge bg-info">ğŸ“„ Document</span>
            {% endif %}
          </td>
          <td>â‚¹{{ "{:,}".format(c.amount) }}</td>
          <td>{{ (c.risk_score * 100)|round(1) if c.risk_score else "â€”" }}%</td>
          <td>
            {% if c.decision == "Auto-Approve" %}
              <span class="badge bg-success">Approved</span>
            {% elif c.decision == "Manual Review" %}
              <span class="badge bg-warning text-dark">Manual</span>
            {% else %}
              <span class="badge bg-danger">Rejected</span>
            {% endif %}
          </td>
          <td>{{ c.created_at | datetimeformat }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ================= POLICY APPLICATIONS ================= -->
<div class="card border-0 shadow-sm rounded-3 mt-4">
  <div class="card-header bg-warning text-dark fw-bold">
    ğŸ“‘ Policy Applications (Document Review)
  </div>

  <div class="card-body table-responsive">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th>User</th><th>Policy</th><th>Status</th>
          <th>Documents</th><th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for up in user_policies %}
        <tr>
          <td>{{ up.user.name }}</td>
          <td>{{ up.policy.name }}</td>
          <td>
            {% if up.status == "active" %}
              <span class="badge bg-success">Active</span>
            {% else %}
              <span class="badge bg-warning text-dark">Pending</span>
            {% endif %}
          </td>

          <td>
            {% if up.uploaded_docs %}
              <button class="btn btn-sm btn-outline-primary"
                      data-bs-toggle="modal"
                      data-bs-target="#docsModal{{ up._id }}">
                ğŸ“ View Docs
              </button>
            {% else %}
              â€”
            {% endif %}
          </td>

          <td>
            {% if not up.doc_valid %}
              <a href="{{ url_for('admin_verify_policy', user_policy_id=up._id|string) }}"
                 class="btn btn-sm btn-success">Approve</a>
            {% else %}â€”{% endif %}
          </td>
        </tr>

        <!-- MODAL -->
        <div class="modal fade" id="docsModal{{ up._id }}" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">ğŸ“‚ Uploaded Documents</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                {% for key, path in up.uploaded_docs.items() %}
                  <div class="d-flex justify-content-between py-2 border-bottom">
                    <span>{{ key.replace('_',' ').title() }}</span>
                    <a href="{{ url_for('admin_files', filename=path) }}"
                       target="_blank"
                       class="btn btn-sm btn-outline-success">
                      View
                    </a>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ================= POLICIES TABLE ================= -->
<div class="card border-0 shadow-sm rounded-3 mt-4">
  <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center">
    ğŸ“„ Manage Policies
    <button class="btn btn-light btn-sm" data-bs-toggle="modal"
            data-bs-target="#addPolicyModal">â• Add Policy</button>
  </div>
  <div class="card-body table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Name</th>
          <th>Category</th>
          <th>Premium</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for p in policy_defs %}
        <tr>
          <td>{{ p.name }}</td>
          <td>{{ p.category }}</td>
          <td>â‚¹{{ "{:,}".format(p.premium_amount) }}</td>
          <td>
            <a href="{{ url_for('admin_delete_policy', policy_id=p._id|string) }}"
               class="btn btn-sm btn-danger">Delete</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.getElementById("userSearch").addEventListener("keyup", function() {
  let filter = this.value.toLowerCase();
  document.querySelectorAll("#usersTable tbody tr").forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
  });
});
</script>
{% endblock %}