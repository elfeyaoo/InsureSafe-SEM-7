{% extends "base.html" %}
{% block content %}
<h4 class="mb-3">‚öôÔ∏è Admin Panel</h4>

<div class="row g-3">
  <!-- Stats Card -->
  <div class="col-lg-4 col-md-12">
    <div class="card border-0 shadow-sm rounded-3 p-3 h-100">
      <div class="d-flex justify-content-around text-center">
        <div>
          <div class="small text-muted">üë§ Users</div>
          <div class="h5 fw-bold">{{ counts.n_users }}</div>
        </div>
        <div>
          <div class="small text-muted">üìÑ Policies</div>
          <div class="h5 fw-bold">{{ counts.n_up }}</div>
        </div>
        <div>
          <div class="small text-muted">üìù Claims</div>
          <div class="h5 fw-bold">{{ counts.n_c }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Users Table -->
  <div class="col-lg-8 col-md-12">
    <div class="card border-0 shadow-sm rounded-3 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="mb-0">üë• Registered Users</h6>
          <input type="text" id="userSearch" class="form-control form-control-sm w-50" placeholder="üîç Search users...">
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle table-hover" id="usersTable">
            <thead class="table-light">
              <tr>
                <th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th class="text-center">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for u in users %}
              <tr>
                <td>{{ u._id|string }}</td>
                <td>{{ u.name }}</td>
                <td>{{ u.email }}</td>
                <td>
                  {% if u.is_admin %}
                    <span class="badge bg-danger">Admin</span>
                  {% else %}
                    <span class="badge bg-info">User</span>
                  {% endif %}
                </td>
                <td>
                  <span class="badge {{ 'bg-success' if u.is_active else 'bg-secondary' }}">
                    {{ 'Active' if u.is_active else 'Inactive' }}
                  </span>
                </td>
                <td class="text-center">
                  {% if not u.is_admin %}
                  <a href="{{ url_for('admin_toggle', uid=u._id|string) }}" class="btn btn-sm btn-outline-primary px-2 py-1">
                    <i class="bi bi-toggle-on"></i> Toggle
                  </a>
                  {% else %}
                  <span class="text-muted small">‚Äî</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Policies Table -->
<div class="card border-0 shadow-sm rounded-3 mt-4">
  <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center">
    üìÑ Manage Policies
    <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addPolicyModal">‚ûï Add Policy</button>
  </div>
  <div class="card-body">
    {% if policy_defs %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>Name</th>
            <th>Category</th>
            <th>Premium</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for p in policy_defs %}
          <tr>
            <td>{{ p.name }}</td>
            <td>{{ p.category }}</td>
            <td>‚Çπ{{ "{:,}".format(p.premium_amount) }}</td>
            <td>
              <a href="{{ url_for('admin_delete_policy', policy_id=p._id|string) }}" class="btn btn-sm btn-danger">üóë Delete</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <p class="text-muted">No policies available.</p>
    {% endif %}
  </div>
</div>

<!-- Add Policy Modal -->
<div class="modal fade" id="addPolicyModal" tabindex="-1" aria-labelledby="addPolicyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form action="{{ url_for('add_policy') }}" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="addPolicyModalLabel">‚ûï Add New Policy</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Name</label>
              <input type="text" name="name" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Category</label>
              <select name="category" class="form-select" required>
                <option value="">Select</option>
                <option value="Health">Health</option>
                <option value="Life">Life</option>
                <option value="Car">Car</option>
                <option value="Education">Education</option>
                <option value="Travel">Travel</option>
              </select>
            </div>
            <div class="col-md-12">
              <label class="form-label">Description</label>
              <textarea name="description" class="form-control" rows="2" required></textarea>
            </div>
            <div class="col-md-12">
              <label class="form-label">Requirements</label>
              <textarea name="requirements" class="form-control" rows="2"></textarea>
            </div>
            <div class="col-md-3">
              <label class="form-label">Min Age</label>
              <input type="number" name="min_age" class="form-control" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Max Age</label>
              <input type="number" name="max_age" class="form-control" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Min Income</label>
              <input type="number" name="min_income" class="form-control" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Max Income</label>
              <input type="number" name="max_income" class="form-control" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Premium Amount</label>
              <input type="number" name="premium_amount" class="form-control" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Duration (Years)</label>
              <input type="number" name="duration_years" class="form-control" required>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add Policy</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.getElementById("userSearch").addEventListener("keyup", function() {
  let filter = this.value.toLowerCase();
  document.querySelectorAll("#usersTable tbody tr").forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
  });
});
</script>
{% endblock %}
