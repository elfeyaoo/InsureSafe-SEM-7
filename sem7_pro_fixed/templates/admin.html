{% extends "base.html" %}
{% block content %}
<h4 class="mb-3">âš™ï¸ Admin Panel</h4>

<div class="row g-3">
  <!-- Stats Card -->
  <div class="col-lg-4 col-md-12">
    <div class="card border-0 shadow-sm rounded-3 p-3 h-100">
      <div class="d-flex justify-content-around text-center">
        <div>
          <div class="small text-muted">ğŸ‘¤ Users</div>
          <div class="h5 fw-bold">{{ counts.n_users }}</div>
        </div>
        <div>
          <div class="small text-muted">ğŸ“„ Policies</div>
          <div class="h5 fw-bold">{{ counts.n_up }}</div>
        </div>
        <div>
          <div class="small text-muted">ğŸ“ Claims</div>
          <div class="h5 fw-bold">{{ counts.n_c }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Users Table -->
  <div class="col-lg-8 col-md-12">
    <div class="card border-0 shadow-sm rounded-3 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="mb-0">ğŸ‘¥ Registered Users</h6>
          <input type="text" id="userSearch" class="form-control form-control-sm w-50" placeholder="ğŸ” Search users...">
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle table-hover" id="usersTable">
            <thead class="table-light">
              <tr>
                <th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th class="text-center">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for u in users %}
              <tr>
                <td>{{ u._id|string }}</td>
                <td>{{ u.name }}</td>
                <td>{{ u.email }}</td>
                <td>
                  {% if u.is_admin %}
                    <span class="badge bg-danger">Admin</span>
                  {% else %}
                    <span class="badge bg-info">User</span>
                  {% endif %}
                </td>
                <td>
                  <span class="badge {{ 'bg-success' if u.is_active else 'bg-secondary' }}">
                    {{ 'Active' if u.is_active else 'Inactive' }}
                  </span>
                </td>
                <td class="text-center">
                  {% if not u.is_admin %}
                  <a href="{{ url_for('admin_toggle', uid=u._id|string) }}" class="btn btn-sm btn-outline-primary">
                    Toggle
                  </a>
                  {% else %}
                  â€”
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ================= CLAIMS TABLE (NEW) ================= -->
<div class="card border-0 shadow-sm rounded-3 mt-4">
  <div class="card-header bg-dark text-white fw-bold">
    ğŸ“ Claims Overview
  </div>
  <div class="card-body table-responsive">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th>ID</th>
          <th>Policy</th>
          <th>Type</th>
          <th>Amount</th>
          <th>Risk</th>
          <th>Decision</th>
          <th>AI Used</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody>
        {% for c in claims %}
        <tr>
          <td>#{{ c._id }}</td>

          <td>
            {{ c.policy.name }}
            <div class="small text-muted">{{ c.policy.category }}</div>
          </td>

          <td>
            {% if c.claim_type == "vehicle" %}
              <span class="badge bg-warning text-dark">ğŸš— Vehicle</span>
            {% else %}
              <span class="badge bg-secondary">ğŸ“„ Normal</span>
            {% endif %}
          </td>

          <td>â‚¹{{ "{:,}".format(c.amount) }}</td>

          <td>
            {% if c.risk_score is not none %}
              {{ (c.risk_score * 100)|round(1) }}%
            {% else %}
              â€”
            {% endif %}
          </td>

          <td>
            {% if c.decision == "Auto-Approve" %}
              <span class="badge bg-success">Auto</span>
            {% elif c.decision == "Manual Review" %}
              <span class="badge bg-warning text-dark">Manual</span>
            {% else %}
              <span class="badge bg-danger">Rejected</span>
            {% endif %}
          </td>

          <td>
            {% if c.claim_type == "vehicle" %}
              YOLO
            {% else %}
              Doc-AI
            {% endif %}
          </td>

          <td>{{ c.created_at | datetimeformat }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ================= POLICIES TABLE ================= -->
<div class="card border-0 shadow-sm rounded-3 mt-4">
  <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center">
    ğŸ“„ Manage Policies
    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addPolicyModal">â• Add Policy</button>
  </div>
  <div class="card-body table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Name</th>
          <th>Category</th>
          <th>Premium</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for p in policy_defs %}
        <tr>
          <td>{{ p.name }}</td>
          <td>{{ p.category }}</td>
          <td>â‚¹{{ "{:,}".format(p.premium_amount) }}</td>
          <td>
            <a href="{{ url_for('admin_delete_policy', policy_id=p._id|string) }}" class="btn btn-sm btn-danger">Delete</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.getElementById("userSearch").addEventListener("keyup", function() {
  let filter = this.value.toLowerCase();
  document.querySelectorAll("#usersTable tbody tr").forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
  });
});
</script>
{% endblock %}
