{% extends "base.html" %}
{% block content %}

<h4 class="mb-3">Recommended Policies for You</h4>

<!-- Filters -->
<form method="GET" class="mb-4">
  <div class="row g-2 align-items-end">

    <div class="col-md-3">
      <label class="form-label">Filter by Category:</label>
      <select name="category" class="form-select">
        <option value="">All Categories</option>
        {% for cat in ['Health','Car','Bike','Life','Family'] %}
          <option value="{{ cat }}" {% if request.args.get('category') == cat %}selected{% endif %}>
            {{ cat }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Min Premium:</label>
      <input type="number" name="min_amount" class="form-control"
             value="{{ request.args.get('min_amount', '') }}" placeholder="e.g. 1000">
    </div>

    <div class="col-md-3">
      <label class="form-label">Max Premium:</label>
      <input type="number" name="max_amount" class="form-control"
             value="{{ request.args.get('max_amount', '') }}" placeholder="e.g. 50000">
    </div>

    <div class="col-md-2">
      <button type="submit" class="btn btn-primary w-100">Apply</button>
    </div>
  </div>
</form>

{% set category_filter = request.args.get('category') %}
{% set min_amount = request.args.get('min_amount') %}
{% set max_amount = request.args.get('max_amount') %}

<!-- ================= RECOMMENDED ================= -->
<div class="row g-3 mb-4">
  {% for p in policies %}
    {% set premium = p.premium_amount or 0 %}
    {% if (p._id|string in recommended_ids)
          and (not category_filter or p.category == category_filter)
          and (not min_amount or premium >= min_amount|int)
          and (not max_amount or premium <= max_amount|int) %}

    <div class="col-md-6 col-lg-4">
      <div class="card border-0 shadow-sm h-100 border-success">
        <div class="card-body d-flex flex-column">

          <h6 class="card-title">
            {{ p.name }}
            <span class="badge bg-warning text-dark">{{ p.category }}</span>

            {% if p._id|string in existing_policy_ids and p._id|string in recommended_ids %}
              <span class="badge bg-info">Owned + Recommended</span>
            {% elif p._id|string in existing_policy_ids %}
              <span class="badge bg-secondary">Already Owned</span>
            {% else %}
              <span class="badge bg-success">
                Recommended (Score: {{ (scores[p._id|string]*100)|round(1) }}%)
              </span>
            {% endif %}
          </h6>

          <p class="text-muted small flex-grow-1">{{ p.description }}</p>

          <div class="mb-2">
            <button class="btn btn-sm btn-outline-secondary"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#rec{{ p._id }}">
              Requirements
            </button>
            <div class="collapse mt-2" id="rec{{ p._id }}">
              <ul class="small mb-0">
                {% for r in (p.requirements or '').split(';') %}
                  {% if r %}<li>{{ r }}</li>{% endif %}
                {% endfor %}
              </ul>
            </div>
          </div>

          {% if p._id|string not in existing_policy_ids %}
            {% if user.annual_income == 0 %}
              <button class="btn btn-secondary mt-auto" disabled
                      title="Income must be greater than zero to apply">
                Income Required
              </button>
            {% else %}
              <a href="{{ url_for('apply_policy', pid=p._id) }}"
                 class="btn btn-primary mt-auto">
                Apply
              </a>
            {% endif %}
          {% else %}
            <button class="btn btn-secondary mt-auto" disabled>Already Owned</button>
          {% endif %}

        </div>

        <div class="card-footer small text-muted">
          Age {{ p.min_age }}–{{ p.max_age }}
          · Income ₹{{ "{:,}".format(p.min_income or 0) }}–
          {% if p.max_income %}
            ₹{{ "{:,}".format(p.max_income) }}
          {% else %}
            No Limit
          {% endif %}
          · Premium ₹{{ "{:,}".format(p.premium_amount or 0) }}
        </div>
      </div>
    </div>
    {% endif %}
  {% endfor %}
</div>

<!-- ================= ALL POLICIES ================= -->
<h4 class="mb-3">All Policies</h4>

<div class="row g-3">
  {% for p in policies %}
    {% set premium = p.premium_amount or 0 %}
    {% if (p._id|string not in recommended_ids)
          and (not category_filter or p.category == category_filter)
          and (not min_amount or premium >= min_amount|int)
          and (not max_amount or premium <= max_amount|int) %}

    <div class="col-md-6 col-lg-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column">

          <h6 class="card-title">
            {{ p.name }}
            <span class="badge bg-warning text-dark">{{ p.category }}</span>
            {% if p._id|string in existing_policy_ids %}
              <span class="badge bg-secondary">Already Owned</span>
            {% endif %}
          </h6>

          <p class="text-muted small flex-grow-1">{{ p.description }}</p>

          <div class="mb-2">
            <button class="btn btn-sm btn-outline-secondary"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#all{{ p._id }}">
              Requirements
            </button>
            <div class="collapse mt-2" id="all{{ p._id }}">
              <ul class="small mb-0">
                {% for r in (p.requirements or '').split(';') %}
                  {% if r %}<li>{{ r }}</li>{% endif %}
                {% endfor %}
              </ul>
            </div>
          </div>

          {% if p._id|string not in existing_policy_ids %}
            {% if user.annual_income == 0 %}
              <button class="btn btn-secondary mt-auto" disabled
                      title="Income must be greater than zero to apply">
                Income Required
              </button>
            {% else %}
              <a href="{{ url_for('apply_policy', pid=p._id) }}"
                 class="btn btn-primary mt-auto">
                Apply
              </a>
            {% endif %}
          {% else %}
            <button class="btn btn-secondary mt-auto" disabled>Already Owned</button>
          {% endif %}

        </div>

        <div class="card-footer small text-muted">
          Age {{ p.min_age }}–{{ p.max_age }}
          · Income ₹{{ "{:,}".format(p.min_income or 0) }}–
          {% if p.max_income %}
            ₹{{ "{:,}".format(p.max_income) }}
          {% else %}
            No Limit
          {% endif %}
          · Premium ₹{{ "{:,}".format(p.premium_amount or 0) }}
        </div>
      </div>
    </div>
    {% endif %}
  {% endfor %}
</div>

{% endblock %}
